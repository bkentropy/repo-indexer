<!DOCTYPE html>
<html>
<head>
    <title>AST Visualizer</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .loading-container {
            text-align: center;
            padding: 20px;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin: 20px;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3498db;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .node {
            cursor: pointer;
        }

        .node circle {
            fill: #fff;
            stroke: steelblue;
            stroke-width: 3px;
        }

        .node:hover circle {
            fill: #e0e0e0;
            stroke: #000;
        }

        .node:hover text {
            fill: #000;
            font-weight: bold;
        }

        .tooltip {
            position: absolute;
            background: #fff;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            pointer-events: none;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        }

        .node text {
            font: 12px sans-serif;
        }

        .link {
            fill: none;
            stroke: #ccc;
            stroke-width: 2px;
        }

        #code-input {
            width: 100%;
            height: 100px;
            margin-bottom: 20px;
        }

        #visualization {
            width: 100%;
            height: 600px;
        }
    </style>
</head>
<body>
    <div id="app">
        <h1>Repository AST Visualizer</h1>
        <div id="visualization"></div>
        <div id="ast-data" style="display: none;"></div>
        <div id="loading" class="loading-container" style="display: none;">
            <div class="loading-spinner"></div>
            <p>Loading AST data from repository...</p>
        </div>
        <div id="error" style="display: none; color: red; margin: 20px;">
            <p>Error: <span id="error-message"></span></p>
        </div>
    </div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize D3 visualization
            const svg = d3.select("#visualization")
                .append("svg")
                .attr("width", "100%")
                .attr("height", "100%")
                .append("g")
                .attr("transform", "translate(40,0)");

            // Function to fetch AST data and initialize visualization
            const fetchAndVisualize = async () => {
                try {
                    const response = await fetch('/ast');
                    const astData = await response.json();
                    
                    if (!Array.isArray(astData) || astData.length === 0) {
                        throw new Error("No AST data received");
                    }
                    
                    // Store the data in the hidden div
                    document.getElementById("ast-data").textContent = JSON.stringify(astData);
                    
                    // Visualize the first tree
                    visualizeAstTree(astData[0]);
                    
                    // Add navigation buttons
                    const navButtons = document.createElement("div");
                    navButtons.innerHTML = `
                        <button onclick="visualizeNextTree()">Next AST</button>
                        <div id="metadata"></div>
                    `;
                    document.getElementById("app").insertBefore(navButtons, document.getElementById("visualization"));
                    
                    // Update metadata for the first tree
                    const metadata = astData[0].metadata;
                    document.getElementById("metadata").innerHTML = `
                        <p>File: ${metadata.file_path}</p>
                        <p>Lines: ${metadata.start_line}-${metadata.end_line}</p>
                        <p>Type: ${metadata.type}</p>
                    `;
                } catch (error) {
                    console.error("Error fetching AST data:", error);
                    document.getElementById("error").style.display = "block";
                    document.getElementById("error-message").textContent = error.message;
                    throw error;
                }
            };

            // Function to visualize a single AST tree
            const visualizeAstTree = (treeData) => {
                // Convert AST to tree structure
                const treeData = {
                    name: treeData.type,
                    children: Object.entries(treeData)
                        .filter(([key]) => key !== 'type' && key !== 'metadata')
                        .map(([key, value]) => ({
                            name: key,
                            children: Array.isArray(value) ? value.map(v => ({
                                name: v.type,
                                children: Object.entries(v)
                                    .filter(([k]) => k !== 'type')
                                    .map(([k, val]) => ({
                                        name: k,
                                        value: typeof val === 'object' ? JSON.stringify(val) : val
                                    }))
                            })) : undefined
                        }))
                };

                // Update the visualization
                const root = d3.hierarchy(treeData);
                const tree = d3.tree().size([600, 400]);
                const nodes = tree(root);
                const links = root.links();

                // Remove existing nodes and links
                svg.selectAll(".node").remove();
                svg.selectAll(".link").remove();

                // Add links
                svg.selectAll(".link")
                    .data(links)
                    .enter().append("path")
                    .attr("class", "link")
                    .attr("d", d => `M${d.source.x},${d.source.y}C${d.source.x},${(d.source.y + d.target.y) / 2} ${d.target.x},${(d.source.y + d.target.y) / 2} ${d.target.x},${d.target.y}`);

                // Add nodes
                const node = svg.selectAll(".node")
                    .data(nodes)
                    .enter().append("g")
                    .attr("class", "node")
                    .attr("transform", d => `translate(${d.x},${d.y})`);

                node.append("circle")
                    .attr("r", 10);

                node.append("text")
                    .attr("dy", 3)
                    .attr("x", d => d.children ? -13 : 13)
                    .style("text-anchor", d => d.children ? "end" : "start")
                    .text(d => d.data.name);

                // Add tooltips
                node.on("mouseover", function(event, d) {
                    const tooltip = d3.select("#tooltip");
                    tooltip.style("visibility", "visible");
                    
                    let content = "";
                    if (d.data.value) {
                        content = `Value: ${d.data.value}`;
                    } else if (d.data.children) {
                        content = `Children: ${d.data.children.length}`;
                    }
                    
                    tooltip.html(content)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 10) + "px");
                })
                .on("mouseout", function() {
                    d3.select("#tooltip").style("visibility", "hidden");
                });
            };

            // Function to cycle through AST trees
            let currentTreeIndex = 0;
            const visualizeNextTree = () => {
                const astData = JSON.parse(document.getElementById("ast-data").textContent);
                if (!astData || astData.length === 0) {
                    alert("No AST data available");
                    return;
                }

                currentTreeIndex = (currentTreeIndex + 1) % astData.length;
                const tree = astData[currentTreeIndex];
                visualizeAstTree(tree);

                // Update metadata display
                const metadata = tree.metadata;
                document.getElementById("metadata").innerHTML = `
                    <p>File: ${metadata.file_path}</p>
                    <p>Lines: ${metadata.start_line}-${metadata.end_line}</p>
                    <p>Type: ${metadata.type}</p>
                `;
            };

            // Initial visualization
            const loadingDiv = document.getElementById("loading");
            loadingDiv.style.display = "block";
            
            fetchAndVisualize().then(() => {
                loadingDiv.style.display = "none";
            }).catch(error => {
                loadingDiv.style.display = "none";
                console.error("Failed to initialize visualization:", error);
            });
        });
    </script>
</body>
</html>
    <h1>Repository AST Visualizer</h1>
    <div id="visualization"></div>
    <div id="ast-data" style="display: none;"></div>
    <div id="loading" class="loading-container" style="display: none;">
        <div class="loading-spinner"></div>
        <p>Loading AST data from repository...</p>
    </div>

    <script>
        // Initialize D3 visualization
        const svg = d3.select("#visualization")
            .append("svg")
            .attr("width", "100%")
            .attr("height", "100%")
            .append("g")
            .attr("transform", "translate(40,0)");

        // Function to fetch AST data and initialize visualization
        const fetchAndVisualize = async () => {
            try {
                const response = await fetch('/ast');
                const astData = await response.json();
                
                if (astData && astData.length > 0) {
                    // Store the data in the hidden div
                    document.getElementById("ast-data").textContent = JSON.stringify(astData);
                    
                    // Visualize the first tree
                    visualizeAstTree(astData[0]);
                    
                    // Add navigation buttons
                    const navButtons = document.createElement("div");
                    navButtons.innerHTML = `
                        <button onclick="visualizeNextTree()">Next AST</button>
                        <div id="metadata"></div>
                    `;
                    document.body.insertBefore(navButtons, document.getElementById("visualization"));
                    
                    // Update metadata for the first tree
                    const metadata = astData[0].metadata;
                    document.getElementById("metadata").innerHTML = `
                        <p>File: ${metadata.file_path}</p>
                        <p>Lines: ${metadata.start_line}-${metadata.end_line}</p>
                        <p>Type: ${metadata.type}</p>
                    `;
                } else {
                    alert("No AST data available");
                }
            } catch (error) {
                console.error("Error fetching AST data:", error);
                alert("Failed to fetch AST data. Please check if the server is running.");
            }
        };

        // Function to visualize a single AST tree
        const visualizeAstTree = (treeData) => {
            // Convert AST to tree structure
            const treeData = {
                name: treeData.type,
                children: Object.entries(treeData)
                    .filter(([key]) => key !== 'type' && key !== 'metadata')
                    .map(([key, value]) => ({
                        name: key,
                        children: Array.isArray(value) ? value.map(v => ({
                            name: v.type,
                            children: Object.entries(v)
                                .filter(([k]) => k !== 'type')
                                .map(([k, val]) => ({
                                    name: k,
                                    value: typeof val === 'object' ? JSON.stringify(val) : val
                                }))
                        })) : undefined
                    }))
            };

            // Update the visualization
            const root = d3.hierarchy(treeData);
            const tree = d3.tree().size([600, 400]);
            const nodes = tree(root);
            const links = root.links();

            // Remove existing nodes and links
            svg.selectAll(".node").remove();
            svg.selectAll(".link").remove();

            // Add links
            svg.selectAll(".link")
                .data(links)
                .enter().append("path")
                .attr("class", "link")
                .attr("d", d => `M${d.source.x},${d.source.y}C${d.source.x},${(d.source.y + d.target.y) / 2} ${d.target.x},${(d.source.y + d.target.y) / 2} ${d.target.x},${d.target.y}`);

            // Add nodes
            const node = svg.selectAll(".node")
                .data(nodes)
                .enter().append("g")
                .attr("class", "node")
                .attr("transform", d => `translate(${d.x},${d.y})`);

            node.append("circle")
                .attr("r", 10);

            node.append("text")
                .attr("dy", 3)
                .attr("x", d => d.children ? -13 : 13)
                .style("text-anchor", d => d.children ? "end" : "start")
                .text(d => d.data.name);

            // Add tooltips
            node.on("mouseover", function(event, d) {
                const tooltip = d3.select("#tooltip");
                tooltip.style("visibility", "visible");
                
                let content = "";
                if (d.data.value) {
                    content = `Value: ${d.data.value}`;
                } else if (d.data.children) {
                    content = `Children: ${d.data.children.length}`;
                }
                
                tooltip.html(content)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 10) + "px");
            })
            .on("mouseout", function() {
                d3.select("#tooltip").style("visibility", "hidden");
            });
        };

        // Function to cycle through AST trees
        let currentTreeIndex = 0;
        const visualizeNextTree = () => {
            const astData = JSON.parse(document.getElementById("ast-data").textContent);
            if (!astData || astData.length === 0) {
                alert("No AST data available");
                return;
            }

            currentTreeIndex = (currentTreeIndex + 1) % astData.length;
            const tree = astData[currentTreeIndex];
            visualizeAstTree(tree);

            // Update metadata display
            const metadata = tree.metadata;
            document.getElementById("metadata").innerHTML = `
                <p>File: ${metadata.file_path}</p>
                <p>Lines: ${metadata.start_line}-${metadata.end_line}</p>
                <p>Type: ${metadata.type}</p>
            `;
        };

        // Initial visualization
        window.onload = async () => {
            const loadingDiv = document.getElementById("loading");
            loadingDiv.style.display = "block";
            
            try {
                await fetchAndVisualize();
                loadingDiv.style.display = "none";
            } catch (error) {
                loadingDiv.innerHTML = `
                    <div class="loading-spinner"></div>
                    <p>Error loading AST data: ${error.message}</p>
                `;
                loadingDiv.style.display = "block";
            }
        };
    </script>
</body>
</html>
