<!DOCTYPE html>
<html>
<head>
    <title>AST Visualizer</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .node {
            cursor: pointer;
        }

        .node circle {
            fill: #fff;
            stroke: steelblue;
            stroke-width: 3px;
        }

        .node:hover circle {
            fill: #e0e0e0;
            stroke: #000;
        }

        .node:hover text {
            fill: #000;
            font-weight: bold;
        }

        .tooltip {
            position: absolute;
            background: #fff;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            pointer-events: none;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        }

        .node text {
            font: 12px sans-serif;
        }

        .link {
            fill: none;
            stroke: #ccc;
            stroke-width: 2px;
        }

        #code-input {
            width: 100%;
            height: 100px;
            margin-bottom: 20px;
        }

        #visualization {
            width: 100%;
            height: 600px;
        }
    </style>
</head>
<body>
    <h1>AST Visualizer</h1>
    <div>
        <textarea id="code-input" placeholder="Enter Python code here...">
# Example code:
def add(a, b):
    return a + b

result = add(2, 3)
        </textarea>
    </div>
    <div id="visualization"></div>

    <script>
        const svg = d3.select("#visualization")
            .append("svg")
            .attr("width", "100%")
            .attr("height", "100%")
            .append("g")
            .attr("transform", "translate(40,0)");

        const updateVisualization = async () => {
            const code = document.getElementById("code-input").value;
            try {
                const response = await fetch(`/ast?code=${encodeURIComponent(code)}`);
                const data = await response.json();
                
                if (data.error) {
                    alert(data.error);
                    return;
                }

                // Convert AST to tree structure
                const treeData = {
                    name: data.type,
                    children: Object.entries(data)
                        .filter(([key]) => key !== 'type')
                        .map(([key, value]) => ({
                            name: key,
                            value: value,
                            children: Array.isArray(value) ? value : [value]
                        }))
                };

                const tree = d3.tree()
                    .size([600, 800]);

                const root = d3.hierarchy(treeData);
                tree(root);

                svg.selectAll("*").remove();

                // Add zoom functionality
                const zoom = d3.zoom()
                    .scaleExtent([0.1, 3])
                    .on("zoom", event => {
                        svg.attr("transform", event.transform);
                    });

                d3.select("#visualization")
                    .call(zoom);

                const g = svg.selectAll(".node")
                    .data(root.descendants())
                    .enter().append("g")
                    .attr("class", "node")
                    .attr("transform", d => `translate(${d.x},${d.y})`)
                    .on("mouseover", function(event, d) {
                        // Show tooltip
                        const tooltip = d3.select("#tooltip");
                        if (tooltip.empty()) {
                            d3.select("body").append("div")
                                .attr("id", "tooltip");
                        }
                        tooltip
                            .style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY - 10) + "px")
                            .html(`
                                <strong>${d.data.name}</strong><br/>
                                ${typeof d.data.value === 'object' ? 
                                    JSON.stringify(d.data.value, null, 2) : 
                                    d.data.value}
                            `)
                            .style("visibility", "visible");
                    })
                    .on("mouseout", function() {
                        d3.select("#tooltip").style("visibility", "hidden");
                    });

                g.append("circle")
                    .attr("r", 10);

                g.append("text")
                    .attr("dy", 3)
                    .attr("x", d => d.children ? -13 : 13)
                    .style("text-anchor", d => d.children ? "end" : "start")
                    .text(d => d.data.name);

                const link = svg.selectAll(".link")
                    .data(root.links())
                    .enter().append("path")
                    .attr("class", "link")
                    .attr("d", d => `M${d.source.x},${d.source.y}C${d.source.x},${(d.source.y + d.target.y) / 2} ${d.target.x},${(d.source.y + d.target.y) / 2} ${d.target.x},${d.target.y}`);
            } catch (error) {
                console.error("Error:", error);
                alert("Failed to visualize AST");
            }
        };

        // Initial visualization
        updateVisualization();

        // Update visualization when code changes
        document.getElementById("code-input").addEventListener("input", updateVisualization);
    </script>
</body>
</html>
